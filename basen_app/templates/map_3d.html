<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Działki na mapie</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet'/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        proj4.defs([['EPSG:2180', '+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs']]);
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0f172a;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .mapboxgl-popup-content {
            padding: 20px;
            border-radius: 8px;
            background: #1e293b;
            color: #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .mapboxgl-popup-tip {
            border-top-color: #1e293b !important;
        }

        .mapboxgl-popup h3 {
            color: #60a5fa;
        }

        .mapboxgl-popup strong {
            color: #93c5fd;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            display: flex;
            gap: 10px;
        }

        .control-button {
            background: #1e293b;
            border: none;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #2d3f5b;
            transform: translateY(-1px);
        }

        .control-button i {
            font-size: 18px;
        }

        .map-style-menu {
            position: absolute;
            top: 60px;
            left: 10px;
            background: #1e293b;
            border-radius: 4px;
            padding: 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1;
        }

        .map-style-menu.active {
            display: block;
        }

        .map-style-menu button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            color: #e2e8f0;
            text-align: left;
            cursor: pointer;
            white-space: nowrap;
        }

        .map-style-menu button:hover {
            background: #2d3f5b;
        }

        .search-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .search-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            z-index: 1001;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #3b4d6b;
            border-radius: 4px;
            background: #2d3f5b;
            color: #e2e8f0;
        }

        .search-input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .search-button {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-button:hover {
            background: #1d4ed8;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            color: #e2e8f0;
        }

        .address-item {
            padding: 10px;
            border-bottom: 1px solid #3b4d6b;
            cursor: pointer;
            transition: background 0.3s;
        }

        .address-item:hover {
            background: #2d3f5b;
        }

        .address-main {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .address-details {
            font-size: 0.9em;
            color: #94a3b8;
        }

        .error {
            color: #ef4444;
            padding: 10px;
        }

        .loading {
            color: #60a5fa;
            padding: 10px;
        }

        .results-count {
            padding: 10px;
            color: #60a5fa;
            border-bottom: 1px solid #3b4d6b;
        }

        .modal-show {
            display: block;
        }
    </style>
</head>
<body>
<div id="map"></div>

<div class="map-controls">
    <button class="control-button" id="styleToggle" title="Zmień styl mapy">
        <i class="fas fa-layer-group"></i>
    </button>
    <button class="control-button" id="searchButton" title="Wyszukaj">
        <i class="fas fa-search"></i>
    </button>
</div>

<div class="map-style-menu" id="styleMenu">
    <button data-style="mapbox://styles/mapbox/navigation-night-v1">Ciemna</button>
    <button data-style="mapbox://styles/mapbox/satellite-streets-v12">Satelita</button>
    <button data-style="mapbox://styles/mapbox/streets-v12">Standardowa</button>
    <button data-style="mapbox://styles/mapbox/outdoors-v12">Terenowa</button>
</div>

<script>
    mapboxgl.accessToken = '#';

    class ParcelMap {
        constructor() {
            this.map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/navigation-night-v1',
                center: [19.4559, 52.1269],
                zoom: 6,
                pitch: 45,
                bearing: 0,
                antialias: true
            });

            this.searchResults = null;
            this.searchModal = null;
            this.searchBackdrop = null;

            this.map.on('load', () => {
                this.initializeLayers();
                this.initializeHandlers();
            });

            this.setupControls();
            window.mapHandler = this;
        }

        initializeLayers() {
            if (!this.map.getSource('mapbox-dem')) {
                this.map.addSource('mapbox-dem', {
                    type: 'raster-dem',
                    url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                    tileSize: 512,
                    maxzoom: 14
                });

                this.map.setTerrain({source: 'mapbox-dem', exaggeration: 1.5});
            }

            if (!this.map.getLayer('3d-buildings')) {
                this.map.addLayer({
                    id: '3d-buildings',
                    source: 'composite',
                    'source-layer': 'building',
                    filter: ['==', 'extrude', 'true'],
                    type: 'fill-extrusion',
                    minzoom: 15,
                    paint: {
                        'fill-extrusion-color': '#1e293b',
                        'fill-extrusion-height': ['get', 'height'],
                        'fill-extrusion-base': ['get', 'min_height'],
                        'fill-extrusion-opacity': 0.8
                    }
                });
            }

            if (!this.map.getSource('selected-parcel')) {
                this.map.addSource('selected-parcel', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: []
                    }
                });

                this.map.addLayer({
                    id: 'parcel-fill',
                    type: 'fill',
                    source: 'selected-parcel',
                    paint: {
                        'fill-color': '#2563eb',
                        'fill-opacity': 0.4
                    }
                });

                this.map.addLayer({
                    id: 'parcel-line',
                    type: 'line',
                    source: 'selected-parcel',
                    paint: {
                        'line-color': '#60a5fa',
                        'line-width': 3
                    }
                });
            }
        }

        setupControls() {
            this.map.addControl(new mapboxgl.NavigationControl());

            const styleToggle = document.getElementById('styleToggle');
            const styleMenu = document.getElementById('styleMenu');
            const searchButton = document.getElementById('searchButton');

            let lastParcelData = null;
            const saveParcelData = () => {
                if (this.map.getSource('selected-parcel')) {
                    lastParcelData = this.map.getSource('selected-parcel').serialize().data;
                }
            };

            styleToggle.addEventListener('click', () => {
                styleMenu.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!styleToggle.contains(e.target) && !styleMenu.contains(e.target)) {
                    styleMenu.classList.remove('active');
                }
            });

            styleMenu.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    saveParcelData();
                    this.map.setStyle(button.dataset.style);
                    styleMenu.classList.remove('active');
                });
            });

            this.map.on('style.load', () => {
                this.initializeLayers();
                if (lastParcelData) {
                    setTimeout(() => {
                        if (this.map.getSource('selected-parcel')) {
                            this.map.getSource('selected-parcel').setData(lastParcelData);
                        }
                    }, 100);
                }
            });

            searchButton.addEventListener('click', () => {
                this.showSearchModal();
            });
        }

        createSearchModal() {
            const modal = document.createElement('div');
            modal.classList.add('search-modal');
            modal.innerHTML = `
            <div class="search-input-container">
                <input type="text" id="address-input" class="search-input"
                       placeholder="Wprowadź adres lub kod pocztowy">
                <button class="search-button">Szukaj</button>
            </div>
            <div id="results" class="search-results"></div>
        `;

            const backdrop = document.createElement('div');
            backdrop.classList.add('search-modal-backdrop');
            backdrop.addEventListener('click', () => this.hideSearchModal());

            const searchButton = modal.querySelector('.search-button');
            searchButton.addEventListener('click', () => this.searchLocation());

            const input = modal.querySelector('#address-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.searchLocation();
                }
            });

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);

            this.searchModal = modal;
            this.searchBackdrop = backdrop;
        }

        showSearchModal() {
            if (!this.searchModal) {
                this.createSearchModal();
            }
            this.searchModal.classList.add('modal-show');
            this.searchBackdrop.classList.add('modal-show');
            this.searchModal.querySelector('#address-input').focus();
        }

        hideSearchModal() {
            if (this.searchModal) {
                this.searchModal.classList.remove('modal-show');
                this.searchBackdrop.classList.remove('modal-show');
            }
        }

        async searchLocation() {
            const addressInput = document.getElementById('address-input');
            const resultsDiv = document.getElementById('results');
            const address = addressInput.value.trim();

            if (!address) {
                resultsDiv.innerHTML = '<div class="error">Wprowadź adres lub kod pocztowy</div>';
                return;
            }

            try {
                const encodedAddress = encodeURIComponent(`${address}, Poland`);
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&countrycodes=pl`;
                resultsDiv.innerHTML = '<div class="loading">Wyszukiwanie adresów...</div>';

                const response = await fetch(nominatimUrl);
                const data = await response.json();

                if (data.length === 0) {
                    throw new Error('Nie znaleziono adresu');
                }

                resultsDiv.innerHTML = `
                <div class="results-count">Znaleziono ${data.length} adresów:</div>
                <div class="address-list">
                    ${data.map((location, index) => {
                    const addressParts = location.display_name.split(', ');
                    return `
                            <div class="address-item" onclick="window.mapHandler.selectAddress(${index})">
                                <div class="address-main">${addressParts[0]}</div>
                                <div class="address-details">${addressParts.slice(1).join(', ')}</div>
                            </div>
                        `;
                }).join('')}
                </div>
            `;

                this.searchResults = data;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async selectAddress(index) {
            if (this.searchResults && this.searchResults[index]) {
                try {
                    const location = this.searchResults[index];
                    await this.processSelectedAddress(location);
                } catch (error) {
                    console.error('Error processing selected address:', error);
                }
            }
        }

        async processSelectedAddress(location) {
            try {
                const {lat, lon} = location;
                this.map.flyTo({
                    center: [lon, lat],
                    zoom: 18,
                    essential: true
                });

                const uldkUrl = `https://uldk.gugik.gov.pl/?request=GetParcelByXY&xy=${lon},${lat},4326&result=geom_wkt,voivodeship,county,commune,region,parcel,teryt`;
                const response = await fetch(uldkUrl);
                const data = await response.text();

                if (data.includes("ERROR")) {
                    throw new Error('Nie znaleziono działki pod wskazanym adresem');
                }

                this.displayParcelInfo(data);
                this.hideSearchModal();
            } catch (error) {
                console.error('Error processing address:', error);
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }


        initializeHandlers() {
            this.map.on('click', async (e) => {
                await this.handleMapClick(e);
            });
        }

        transformCoordinates(x, y) {
            try {
                const result = proj4('EPSG:2180', 'EPSG:4326', [x, y]);
                return [result[0], result[1]];
            } catch (error) {
                console.error('Transform error:', error);
                return null;
            }
        }

        parseWKT(wkt) {
            try {
                const cleanWkt = wkt.replace(/^[0-9]+ SRID=[0-9]+;/, '');
                let coordinates = [];

                if (cleanWkt.includes('MULTIPOLYGON')) {
                    const matches = cleanWkt.match(/\(\((.*?)\)\)/g);
                    if (!matches) return null;

                    matches.forEach(match => {
                        const coords = match.replace(/\(|\)/g, '')
                            .split(',')
                            .map(pair => {
                                const [x, y] = pair.trim().split(' ').map(Number);
                                const transformed = this.transformCoordinates(x, y);
                                if (!transformed) throw new Error('Invalid coordinates');
                                return transformed;
                            });
                        coordinates.push(coords);
                    });
                    return coordinates[0];
                } else {
                    const coordsMatch = cleanWkt.match(/POLYGON\(\((.*)\)\)/);
                    if (!coordsMatch) return null;

                    coordinates = coordsMatch[1].split(',').map(pair => {
                        const [x, y] = pair.trim().split(' ').map(Number);
                        const transformed = this.transformCoordinates(x, y);
                        if (!transformed) throw new Error('Invalid coordinates');
                        return transformed;
                    });
                }
                return coordinates;
            } catch (e) {
                console.error('WKT parse error:', e);
                return null;
            }
        }

        async handleMapClick(e) {
            const {lng, lat} = e.lngLat;
            await this.fetchAndDisplayParcelInfo(lat, lng);
        }

        async fetchAndDisplayParcelInfo(lat, lon) {
            try {
                const response = await fetch(
                    `https://uldk.gugik.gov.pl/?request=GetParcelByXY&xy=${lon},${lat},4326&result=geom_wkt,voivodeship,county,commune,region,parcel,teryt`
                );
                const data = await response.text();
                if (!data.includes("ERROR")) {
                    this.displayParcelInfo(data);
                }
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        displayParcelInfo(data) {
            const [wkt, voivodeship, county, commune, region, parcel, teryt] = data.split('|');
            if (!wkt || wkt.includes("ERROR")) return;

            const coords = this.parseWKT(wkt);
            if (!coords || !coords.length) return;

            const geojson = {
                type: 'FeatureCollection',
                features: [{
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [coords]
                    },
                    properties: {teryt, voivodeship, county, commune, region, parcel}
                }]
            };

            if (this.map.getSource('selected-parcel')) {
                this.map.getSource('selected-parcel').setData(geojson);

                new mapboxgl.Popup()
                    .setLngLat(coords[0])
                    .setHTML(`
                    <div class="popup-content">
                        <h3>Informacja o działce</h3>
                        <p><strong>TERYT:</strong> ${teryt || 'N/A'}</p>
                        <p><strong>Województwo:</strong> ${voivodeship || 'N/A'}</p>
                        <p><strong>Powiat:</strong> ${county || 'N/A'}</p>
                        <p><strong>Gmina:</strong> ${commune || 'N/A'}</p>
                        <p><strong>Obręb:</strong> ${region || 'N/A'}</p>
                        <p><strong>Nr działki:</strong> ${parcel || 'N/A'}</p>
                    </div>
                `)
                    .addTo(this.map);

                const bounds = coords.reduce((bounds, coord) => {
                    return bounds.extend(coord);
                }, new mapboxgl.LngLatBounds(coords[0], coords[0]));

                this.map.fitBounds(bounds, {
                    padding: 50,
                    maxZoom: 19
                });
            }
        }
    }

    const parcelMap = new ParcelMap();

    // Добавляем обработчики для карточек участков
    document.querySelectorAll('.parcel-card').forEach(card => {
        card.addEventListener('click', async () => {
            const parcelId = card.dataset.parcelId;
            const response = await fetch(`/app/get-parcel-geometry/${parcelId}/`);
            const data = await response.text();
            parcelMap.displayParcelInfo(data);
        });
    });
</script>
</body>
</html>